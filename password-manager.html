<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0e27">
    <title>PocketVault</title>
    <link rel="manifest" href="manifest.json">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #141b3d;
            --bg-tertiary: #1a2351;
            --accent-primary: #00d9ff;
            --accent-secondary: #7b61ff;
            --text-primary: #ffffff;
            --text-secondary: #a8b2d1;
            --text-muted: #6b7ba8;
            --success: #00ff88;
            --warning: #ffa500;
            --danger: #ff4757;
            --inactive: #2a3357;
            --border: #2a3666;
            --shadow: rgba(0, 0, 0, 0.3);
        }
        
        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0d1233 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            overflow-x: hidden;
        }
        
        /* Background decoration */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0, 217, 255, 0.1) 0%, transparent 70%);
            pointer-events: none;
            animation: pulse 8s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: slideDown 0.6s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .app-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            letter-spacing: -1px;
        }
        
        .app-subtitle {
            font-size: 0.95rem;
            color: var(--text-muted);
            font-weight: 300;
        }
        
        .screen {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            margin-bottom: 12px;
            font-family: 'Outfit', sans-serif;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 217, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
            font-weight: 600;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #00b8d4, #6347d6);
            box-shadow: 0 8px 30px rgba(0, 217, 255, 0.4);
        }
        
        .btn-danger {
            background: var(--danger);
            border: none;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff3344;
        }
        
        .btn-success {
            background: var(--success);
            border: none;
            color: var(--bg-primary);
            font-weight: 600;
        }
        
        .btn-success:hover {
            background: #00e67a;
        }
        
        .btn-inactive {
            background: var(--inactive);
            opacity: 0.7;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.875rem;
            margin-bottom: 8px;
        }
        
        .badge {
            background: rgba(0, 217, 255, 0.2);
            color: var(--accent-primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .back-btn {
            margin-bottom: 24px;
            background: transparent;
            border: 1px solid var(--border);
            padding: 12px 20px;
            font-size: 0.9rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
        }
        
        select.form-input {
            cursor: pointer;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .field-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        
        .field-content {
            flex: 1;
            min-width: 0;
        }
        
        .field-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .field-value {
            font-size: 1rem;
            color: var(--text-primary);
            word-break: break-all;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .field-value.hidden {
            font-family: 'Outfit', sans-serif;
            letter-spacing: 2px;
        }
        
        .field-actions {
            display: flex;
            gap: 8px;
        }
        
        .icon-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--accent-primary);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }
        
        .icon-btn:hover {
            background: var(--accent-primary);
            color: var(--bg-primary);
            transform: scale(1.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--accent-primary);
        }
        
        .tag-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .tag-name {
            font-weight: 500;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .empty-state-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .empty-state-subtext {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .version-info {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .version-name {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .version-date {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .action-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .action-bar .btn {
            flex: 1;
            min-width: 150px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        @media (max-width: 600px) {
            .app-title {
                font-size: 2rem;
            }
            
            .container {
                padding: 16px;
            }
            
            .modal-content {
                padding: 20px;
            }
            
            .action-bar {
                flex-direction: column;
            }
            
            .action-bar .btn {
                width: 100%;
            }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }
        
        /* Toggle switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 30px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--inactive);
            transition: 0.3s;
            border-radius: 30px;
            border: 1px solid var(--border);
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background: linear-gradient(135deg, var(--success), #00cc77);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toggle-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* App button specific styling */
        .app-button-container {
            display: flex;
            gap: 8px;
        }
        
        .btn-app {
            background: linear-gradient(135deg, var(--accent-secondary), #5a47cc);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
        }
        
        .btn-app:hover {
            background: linear-gradient(135deg, #6b58dd, #4a37bb);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(123, 97, 255, 0.4);
        }
        
        .btn-app:disabled {
            background: var(--inactive);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .btn-app:disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* Grid layout for tags and accounts */
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .button-grid .btn {
            margin-bottom: 0;
            padding: 12px 16px;
            font-size: 0.9rem;
        }
        
        .button-grid .btn-plus {
            padding: 0;
        }
        
        /* Corner buttons */
        .corner-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-bottom: 24px;
        }
        
        .btn-corner {
            padding: 10px 16px;
            font-size: 0.85rem;
            width: auto;
            min-width: 140px;
        }
        
        /* Version info simple (just version name + date) */
        .version-info-simple {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }
        
        .version-info-simple .version-name {
            font-weight: 600;
        }
        
        .version-info-simple .version-date {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Version button with export */
        .version-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 18px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .version-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
        }
        
        .version-btn-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            text-align: left;
        }
        
        .version-btn-date {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            margin-right: 12px;
        }
        
        .version-btn .btn-inline {
            position: relative;
            z-index: 2;
        }
        
        @media (max-width: 600px) {
            .button-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .button-grid .btn {
                padding: 10px 12px;
                font-size: 0.85rem;
            }
            
            .corner-buttons {
                flex-direction: column;
            }
            
            .btn-corner {
                width: 100%;
            }
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 6px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
        }
        
        .tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }
        
        .tab-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        /* Inline export button */
        .version-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .version-details {
            flex: 1;
        }
        
        .btn-inline {
            padding: 6px 14px;
            font-size: 0.8rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
            white-space: nowrap;
        }
        
        .btn-inline:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        /* Plus button for adding accounts */
        .btn-plus {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: var(--accent-primary);
            background: var(--bg-secondary);
            border: 2px dashed var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 12px 16px;
            margin: 0;
        }
        
        .btn-plus:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }
        
        /* Back arrow button */
        .btn-back-arrow {
            background: transparent;
            border: none;
            color: var(--accent-primary);
            font-size: 2rem;
            font-weight: 300;
            cursor: pointer;
            padding: 0;
            margin-bottom: 20px;
            display: block;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
        }
        
        .btn-back-arrow:hover {
            color: var(--text-primary);
            transform: translateX(-5px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="app-title">üîê PocketVault</h1>
            <p class="app-subtitle">Local Account Management</p>
        </div>

        <!-- Version Selection Screen -->
        <div id="versionScreen" class="screen active">
            <div class="tab-nav">
                <button class="tab-btn active">Versions</button>
                <button class="tab-btn" onclick="app.goToTags()">Tags</button>
                <button class="tab-btn" onclick="app.goToAccounts()">Accounts</button>
            </div>
            <div id="versionList"></div>
            <input type="file" id="importFile" accept=".json">
        </div>

        <!-- Tag Selection Screen -->
        <div id="tagScreen" class="screen">
            <div class="tab-nav">
                <button class="tab-btn" onclick="app.showVersionScreen()">Versions</button>
                <button class="tab-btn active">Tags</button>
                <button class="tab-btn" onclick="app.goToAccounts()">Accounts</button>
            </div>
            <div class="version-info-simple">
                <span class="version-name" id="currentVersionName"></span>
                <span class="version-date" id="currentVersionDate"></span>
            </div>
            <div class="action-bar" id="versionActions" style="display: none;">
                <button class="btn btn-primary" onclick="app.pushAllToVersion()">Push All to Primary</button>
                <button class="btn btn-danger" onclick="app.deleteCurrentVersion()">Delete Version</button>
            </div>
            <div id="tagList" class="button-grid"></div>
        </div>

        <!-- Account List Screen -->
        <div id="accountScreen" class="screen">
            <div class="tab-nav">
                <button class="tab-btn" onclick="app.showVersionScreen()">Versions</button>
                <button class="tab-btn" onclick="app.showTagScreen()">Tags</button>
                <button class="tab-btn active">Accounts</button>
            </div>
            <h2 style="margin-bottom: 12px; color: var(--accent-primary);" id="selectedTag"></h2>
            <div class="version-info-simple">
                <span class="version-name" id="accountVersionName"></span>
                <span class="version-date" id="accountVersionDate"></span>
            </div>
            <div id="accountList" class="button-grid"></div>
        </div>

        <!-- Account Detail Screen -->
        <div id="detailScreen" class="screen">
            <button class="btn-back-arrow" onclick="app.closeDetailScreen()" title="Back">‚Üê</button>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="color: var(--accent-primary); margin: 0;" id="accountTitle"></h2>
                <div style="display: flex; gap: 12px;">
                    <button class="icon-btn" id="mergeAccountBtn" onclick="app.pushAccountToVersion()" title="Merge to Primary" style="display: none;">üîÑ</button>
                    <button class="icon-btn" onclick="app.showEditAccountModal()" title="Edit Account">‚úèÔ∏è</button>
                    <button class="icon-btn" onclick="app.deleteAccount()" title="Delete Account" style="color: var(--danger);">üóëÔ∏è</button>
                </div>
            </div>
            <div id="fieldList"></div>
            <button class="btn" onclick="app.showTagsModal()">üè∑Ô∏è Manage Tags</button>
            <button class="btn" onclick="app.showCustomFieldModal()">+ Add Custom Field</button>
            <button class="btn" onclick="app.closeDetailScreen()" style="margin-top: 20px; background: transparent; border: 1px solid var(--border);">Exit</button>
        </div>
    </div>

    <!-- Add/Edit Account Modal -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header" id="accountModalTitle">Add New Account</h3>
            <form id="accountForm">
                <div class="form-group">
                    <label class="form-label">Account Title *</label>
                    <input type="text" id="accountTitleInput" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Username *</label>
                    <input type="text" id="usernameInput" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="emailInput" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Password *</label>
                    <input type="password" id="passwordInput" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">URL</label>
                    <input type="text" id="urlInput" class="form-input" placeholder="facebook.com or https://example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">App Link</label>
                    <select id="appLinkSelect" class="form-input">
                        <option value="">-- Select App --</option>
                        <option value="custom">Custom Link</option>
                        <option value="instagram://">Instagram</option>
                        <option value="fb://">Facebook</option>
                        <option value="twitter://">Twitter/X</option>
                        <option value="linkedin://">LinkedIn</option>
                        <option value="tiktok://">TikTok</option>
                        <option value="snapchat://">Snapchat</option>
                        <option value="youtube://">YouTube</option>
                        <option value="gmail://">Gmail</option>
                        <option value="spotify://">Spotify</option>
                        <option value="netflix://">Netflix</option>
                        <option value="amazon://">Amazon</option>
                        <option value="whatsapp://">WhatsApp</option>
                        <option value="telegram://">Telegram</option>
                        <option value="reddit://">Reddit</option>
                        <option value="pinterest://">Pinterest</option>
                    </select>
                    <input type="text" id="customAppInput" class="form-input" placeholder="Custom app link" style="margin-top: 10px; display: none;">
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="activeInput" checked>
                        <label class="form-label" style="margin: 0;">Active Account</label>
                    </div>
                </div>
                <div id="customFieldsEdit"></div>
                <div style="display: flex; gap: 12px;">
                    <button type="submit" class="btn btn-primary">Save Account</button>
                    <button type="button" class="btn" onclick="app.closeModal('accountModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tags Modal -->
    <div id="tagsModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header">Manage Tags</h3>
            <div id="currentTags"></div>
            <div id="addTagSection"></div>
            <button class="btn" onclick="app.closeModal('tagsModal')">Close</button>
        </div>
    </div>

    <!-- Custom Field Modal -->
    <div id="customFieldModal" class="modal">
        <div class="modal-content" id="customFieldModalContent">
        </div>
    </div>

    <!-- Push Conflict Resolution Modal -->
    <div id="pushModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header">Push to Primary</h3>
            <p style="margin-bottom: 20px; color: var(--text-secondary);">When values exist in both Primary and this version, which should be kept?</p>
            <button class="btn btn-primary" onclick="app.executePush('version')" style="margin-bottom: 12px;">Keep Versioned Values</button>
            <button class="btn" onclick="app.executePush('primary')" style="margin-bottom: 12px;">Keep Primary Values</button>
            <button class="btn" onclick="app.closeModal('pushModal')">Cancel</button>
        </div>
    </div>

    <script>
        const app = {
            db: null,
            currentVersion: 'Primary',
            currentTag: null,
            currentAccount: null,
            isEditing: false,
            pushType: null, // 'all' or 'single'
            exportDataCache: null,
            exportFilename: null,
            customFieldStep: 'name',
            customFieldName: null,
            
            async init() {
                await this.initDB();
                this.setupEventListeners();
                
                // Ensure Primary exists
                await this.saveVersion('Primary');
                
                // Set currentVersion like the tab navigation does
                this.currentVersion = 'Primary';
                
                // Call showTagScreen first (this seems to initialize something)
                await this.showTagScreen();
                
                // Then immediately switch back to version screen
                await this.showVersionScreen();
            },
            
            async initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('PocketVaultDB', 1);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('passwords')) {
                            const store = db.createObjectStore('passwords', { keyPath: 'id', autoIncrement: true });
                            store.createIndex('version', 'version', { unique: false });
                            store.createIndex('accountTitle', 'accountTitle', { unique: false });
                            store.createIndex('attribute', 'attribute', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('versions')) {
                            db.createObjectStore('versions', { keyPath: 'name' });
                        }
                    };
                });
            },
            
            setupEventListeners() {
                document.getElementById('importFile').addEventListener('change', (e) => this.importBackup(e));
                document.getElementById('accountForm').addEventListener('submit', (e) => this.saveAccount(e));
                document.getElementById('appLinkSelect').addEventListener('change', (e) => {
                    const customInput = document.getElementById('customAppInput');
                    customInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
                });
                document.getElementById('tagSelect').addEventListener('change', (e) => {
                    const newTagInput = document.getElementById('newTagInput');
                    newTagInput.style.display = e.target.value === 'new' ? 'block' : 'none';
                });
            },
            
            async getAllVersions() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['versions'], 'readonly');
                    const store = transaction.objectStore('versions');
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            
            async saveVersion(name, timestamp = Date.now()) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['versions'], 'readwrite');
                    const store = transaction.objectStore('versions');
                    const request = store.put({ name, timestamp });
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },
            
            async showVersionScreen() {
                this.currentVersion = null;
                this.currentTag = null;
                this.currentAccount = null;
                
                const versionList = document.getElementById('versionList');
                
                // Ensure Primary version exists in database
                const primaryExists = await this.getVersionData('Primary');
                if (!primaryExists) {
                    await this.saveVersion('Primary');
                }
                
                // Get versions from database
                const versions = await this.getAllVersions();
                
                // Ensure we have at least Primary
                if (versions.length === 0) {
                    await this.saveVersion('Primary');
                    // Wait a moment for the write to complete
                    await new Promise(resolve => setTimeout(resolve, 50));
                    versions.push({ name: 'Primary', timestamp: Date.now() });
                }
                
                let html = '';
                versions.forEach(version => {
                    const date = new Date(version.timestamp).toLocaleString();
                    const isPrimary = version.name === 'Primary';
                    
                    if (isPrimary) {
                        // Primary with import/export icons
                        html += `
                            <div class="version-btn" onclick="app.selectVersion('${version.name}')">
                                <span class="version-btn-name">${version.name}</span>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn-inline" onclick="event.stopPropagation(); document.getElementById('importFile').click()" title="Import Backup">üì§</button>
                                    <button class="btn-inline" onclick="event.stopPropagation(); app.exportPrimary()" title="Export Primary">üíæ</button>
                                </div>
                            </div>
                        `;
                    } else {
                        // Versions with date
                        html += `
                            <div class="version-btn" onclick="app.selectVersion('${version.name}')">
                                <span class="version-btn-name">${version.name.replace('v', 'Version ')}</span>
                                <span class="version-btn-date">Date: ${date}</span>
                            </div>
                        `;
                    }
                });
                
                versionList.innerHTML = html;
                this.showScreen('versionScreen');
            },
            
            async selectVersion(versionName) {
                this.currentVersion = versionName;
                await this.showTagScreen();
            },
            
            async goToTags() {
                if (!this.currentVersion) {
                    this.currentVersion = 'Primary';
                }
                await this.showTagScreen();
            },
            
            async goToAccounts() {
                if (!this.currentVersion) {
                    this.currentVersion = 'Primary';
                }
                this.currentTag = null; // Show all accounts
                await this.showAccountScreen();
            },
            
            async showTagScreen() {
                const tags = await this.getAllTags(this.currentVersion);
                const accounts = await this.getAccountsByVersion(this.currentVersion);
                
                const displayVersion = this.currentVersion.replace('v', 'Version ');
                document.getElementById('currentVersionName').textContent = displayVersion;
                const versionData = await this.getVersionData(this.currentVersion);
                document.getElementById('currentVersionDate').textContent = versionData ? new Date(versionData.timestamp).toLocaleString() : '';
                
                // Show version-specific actions if not Primary
                const versionActions = document.getElementById('versionActions');
                versionActions.style.display = this.currentVersion !== 'Primary' ? 'flex' : 'none';
                
                const tagList = document.getElementById('tagList');
                let html = `
                    <button class="btn btn-primary" onclick="app.selectTag(null)">
                        <span style="flex: 1;">ALL</span>
                        <span class="badge">${accounts.length}</span>
                    </button>
                `;
                
                // Sort tags by count
                const tagCounts = {};
                tags.forEach(tag => {
                    tagCounts[tag] = accounts.filter(acc => {
                        const accTags = acc.filter(item => item.attribute === 'tag').map(item => item.value);
                        return accTags.includes(tag);
                    }).length;
                });
                
                const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);
                
                sortedTags.forEach(([tag, count]) => {
                    html += `
                        <button class="btn" onclick="app.selectTag('${tag}')">
                            <span style="flex: 1;">${tag}</span>
                            <span class="badge">${count}</span>
                        </button>
                    `;
                });
                
                tagList.innerHTML = html;
                this.showScreen('tagScreen');
            },
            
            async getVersionData(versionName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['versions'], 'readonly');
                    const store = transaction.objectStore('versions');
                    const request = store.get(versionName);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            
            async getAllTags(version) {
                const records = await this.getRecordsByVersion(version);
                const tags = new Set();
                records.filter(r => r.attribute === 'tag').forEach(r => tags.add(r.value));
                return Array.from(tags);
            },
            
            async getAccountsByVersion(version) {
                const records = await this.getRecordsByVersion(version);
                const accountMap = {};
                
                records.forEach(record => {
                    if (!accountMap[record.accountTitle]) {
                        accountMap[record.accountTitle] = [];
                    }
                    accountMap[record.accountTitle].push(record);
                });
                
                return Object.values(accountMap);
            },
            
            async selectTag(tag) {
                this.currentTag = tag;
                await this.showAccountScreen();
            },
            
            async showAccountScreen() {
                const accounts = await this.getAccountsByVersion(this.currentVersion);
                
                const displayVersion = this.currentVersion.replace('v', 'Version ');
                document.getElementById('accountVersionName').textContent = displayVersion;
                const versionData = await this.getVersionData(this.currentVersion);
                document.getElementById('accountVersionDate').textContent = versionData ? new Date(versionData.timestamp).toLocaleString() : '';
                
                let filteredAccounts = accounts;
                if (this.currentTag) {
                    filteredAccounts = accounts.filter(acc => {
                        const tags = acc.filter(item => item.attribute === 'tag').map(item => item.value);
                        return tags.includes(this.currentTag);
                    });
                }
                
                // Sort: active first (alphabetically), then inactive (alphabetically)
                filteredAccounts.sort((a, b) => {
                    const aActive = a.find(item => item.attribute === 'active_flag')?.value === 'true';
                    const bActive = b.find(item => item.attribute === 'active_flag')?.value === 'true';
                    
                    if (aActive !== bActive) {
                        return bActive ? 1 : -1;
                    }
                    
                    return a[0].accountTitle.localeCompare(b[0].accountTitle);
                });
                
                document.getElementById('selectedTag').textContent = this.currentTag || 'All Accounts';
                
                const accountList = document.getElementById('accountList');
                
                // Start with plus button
                let html = '<button class="btn-plus" onclick="app.showAddAccountModal()" title="Add New Account">+</button>';
                
                filteredAccounts.forEach(account => {
                    const title = account[0].accountTitle;
                    const isActive = account.find(item => item.attribute === 'active_flag')?.value === 'true';
                    const btnClass = isActive ? 'btn' : 'btn btn-inactive';
                    
                    html += `
                        <button class="${btnClass}" onclick="app.selectAccount('${title}')">
                            ${title}
                        </button>
                    `;
                });
                
                if (filteredAccounts.length === 0) {
                    html = `
                        <button class="btn-plus" onclick="app.showAddAccountModal()" title="Add New Account">+</button>
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <div class="empty-state-icon">üì≠</div>
                            <div class="empty-state-text">No accounts found</div>
                            <div class="empty-state-subtext">Click + to add your first account</div>
                        </div>
                    `;
                }
                
                accountList.innerHTML = html;
                this.showScreen('accountScreen');
            },
            
            async selectAccount(accountTitle) {
                this.currentAccount = accountTitle;
                await this.showDetailScreen();
            },
            
            async showDetailScreen() {
                const records = await this.getRecordsByVersion(this.currentVersion);
                const accountRecords = records.filter(r => r.accountTitle === this.currentAccount);
                
                // Show merge button if not Primary
                const mergeBtn = document.getElementById('mergeAccountBtn');
                mergeBtn.style.display = this.currentVersion !== 'Primary' ? 'inline-flex' : 'none';
                
                document.getElementById('accountTitle').textContent = this.currentAccount;
                
                const fieldList = document.getElementById('fieldList');
                let html = '';
                
                const standardFields = ['username', 'email', 'password', 'url', 'app', 'active_flag'];
                const customFields = [];
                
                // Standard fields first
                standardFields.forEach(field => {
                    const record = accountRecords.find(r => r.attribute === field);
                    if (record) {
                        html += this.renderField(field, record.value);
                    }
                });
                
                // Custom fields
                accountRecords.forEach(record => {
                    if (!standardFields.includes(record.attribute) && record.attribute !== 'tag') {
                        html += this.renderField(record.attribute, record.value, true);
                    }
                });
                
                fieldList.innerHTML = html;
                this.showScreen('detailScreen');
            },
            
            renderField(label, value, isCustom = false) {
                const isPassword = label === 'password';
                const isApp = label === 'app';
                const isActiveFlag = label === 'active_flag';
                const isUrl = label === 'url';
                const displayLabel = label.replace('_', ' ').toUpperCase();
                
                // Handle active flag as toggle
                if (isActiveFlag) {
                    const isActive = value === 'true';
                    return `
                        <div class="field-item">
                            <div class="field-content">
                                <div class="field-label">${displayLabel}</div>
                                <div class="toggle-container">
                                    <label class="toggle-switch">
                                        <input type="checkbox" ${isActive ? 'checked' : ''} onchange="app.toggleActiveFlag(this.checked)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">${isActive ? 'Active' : 'Inactive'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Handle app as button
                if (isApp) {
                    const hasApp = value && value.trim() !== '';
                    return `
                        <div class="field-item">
                            <div class="field-content">
                                <div class="field-label">APP LINK</div>
                                <div class="app-button-container">
                                    <button class="btn-app" ${!hasApp ? 'disabled' : ''} onclick="${hasApp ? `app.openApp('${value}')` : ''}">
                                        ${hasApp ? 'üì± Open App' : 'üì± No App Set'}
                                    </button>
                                </div>
                            </div>
                            <div class="field-actions">
                                <button class="icon-btn" onclick="app.showEditAppModal()" title="Edit App Link">‚úèÔ∏è</button>
                            </div>
                        </div>
                    `;
                }
                
                // Handle URL as clickable link if valid
                if (isUrl) {
                    const isValidUrl = this.isValidUrl(value);
                    const displayValue = isValidUrl 
                        ? `<a href="${value}" target="_blank" rel="noopener noreferrer" style="color: var(--accent-primary); text-decoration: underline;">${value}</a>`
                        : value;
                    
                    return `
                        <div class="field-item">
                            <div class="field-content">
                                <div class="field-label">${displayLabel}</div>
                                <div class="field-value">${displayValue}</div>
                            </div>
                            <div class="field-actions">
                                <button class="icon-btn" onclick="app.copyToClipboard('${value}')" title="Copy">üìã</button>
                            </div>
                        </div>
                    `;
                }
                
                // Regular fields
                const displayValue = isPassword ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : value;
                const valueClass = isPassword ? 'field-value hidden' : 'field-value';
                
                let actions = '';
                if (isPassword) {
                    actions += `<button class="icon-btn" onclick="app.togglePassword(this)" title="Show/Hide">üëÅÔ∏è</button>`;
                }
                actions += `<button class="icon-btn" onclick="app.copyToClipboard('${value}')" title="Copy">üìã</button>`;
                if (isCustom) {
                    actions += `<button class="icon-btn" onclick="app.deleteCustomField('${label}')" title="Delete" style="color: var(--danger);">üóëÔ∏è</button>`;
                }
                
                return `
                    <div class="field-item">
                        <div class="field-content">
                            <div class="field-label">${displayLabel}</div>
                            <div class="${valueClass}" data-value="${value}">${displayValue}</div>
                        </div>
                        <div class="field-actions">
                            ${actions}
                        </div>
                    </div>
                `;
            },
            
            isValidUrl(string) {
                try {
                    const url = new URL(string);
                    return url.protocol === 'http:' || url.protocol === 'https:';
                } catch (_) {
                    return false;
                }
            },
            
            togglePassword(btn) {
                const fieldValue = btn.closest('.field-item').querySelector('.field-value');
                const actualValue = fieldValue.getAttribute('data-value');
                
                if (fieldValue.classList.contains('hidden')) {
                    fieldValue.textContent = actualValue;
                    fieldValue.classList.remove('hidden');
                    btn.textContent = 'üôà';
                } else {
                    fieldValue.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    fieldValue.classList.add('hidden');
                    btn.textContent = 'üëÅÔ∏è';
                }
            },
            
            async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    alert('Copied to clipboard!');
                } catch (err) {
                    console.error('Failed to copy:', err);
                }
            },
            
            async toggleActiveFlag(isActive) {
                await this.deleteRecordsByAttribute(this.currentVersion, this.currentAccount, 'active_flag');
                await this.saveRecord(this.currentVersion, this.currentAccount, 'active_flag', isActive.toString());
                await this.saveVersion(this.currentVersion);
                // Update the label
                const label = document.querySelector('.toggle-label');
                if (label) {
                    label.textContent = isActive ? 'Active' : 'Inactive';
                }
            },
            
            showEditAppModal() {
                // Reuse the account modal but only show app field
                this.isEditingApp = true;
                
                // Get current app value
                this.getAccountRecords(this.currentVersion, this.currentAccount).then(records => {
                    const appRecord = records.find(r => r.attribute === 'app');
                    const currentApp = appRecord ? appRecord.value : '';
                    
                    // Show a simple prompt for now (we can make this fancier later)
                    const select = document.getElementById('appLinkSelect');
                    const customInput = document.getElementById('customAppInput');
                    
                    const found = Array.from(select.options).find(opt => opt.value === currentApp);
                    if (found) {
                        select.value = currentApp;
                        customInput.style.display = 'none';
                    } else if (currentApp) {
                        select.value = 'custom';
                        customInput.style.display = 'block';
                        customInput.value = currentApp;
                    } else {
                        select.value = '';
                        customInput.style.display = 'none';
                    }
                    
                    // Show modal with just app selection
                    const modal = `
                        <div id="editAppModal" class="modal active">
                            <div class="modal-content">
                                <h3 class="modal-header">Edit App Link</h3>
                                <div class="form-group">
                                    <label class="form-label">App Link</label>
                                    <select id="editAppSelect" class="form-input">
                                        <option value="">-- Select App --</option>
                                        <option value="custom">Custom Link</option>
                                        <option value="instagram://">Instagram</option>
                                        <option value="fb://">Facebook</option>
                                        <option value="twitter://">Twitter/X</option>
                                        <option value="linkedin://">LinkedIn</option>
                                        <option value="tiktok://">TikTok</option>
                                        <option value="snapchat://">Snapchat</option>
                                        <option value="youtube://">YouTube</option>
                                        <option value="gmail://">Gmail</option>
                                        <option value="spotify://">Spotify</option>
                                        <option value="netflix://">Netflix</option>
                                        <option value="amazon://">Amazon</option>
                                        <option value="whatsapp://">WhatsApp</option>
                                        <option value="telegram://">Telegram</option>
                                        <option value="reddit://">Reddit</option>
                                        <option value="pinterest://">Pinterest</option>
                                    </select>
                                    <input type="text" id="editCustomAppInput" class="form-input" placeholder="Custom app link" style="margin-top: 10px; display: none;">
                                </div>
                                <div style="display: flex; gap: 12px;">
                                    <button class="btn btn-primary" onclick="app.saveAppLink()">Save</button>
                                    <button class="btn" onclick="app.closeEditAppModal()">Cancel</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Remove old modal if exists
                    const oldModal = document.getElementById('editAppModal');
                    if (oldModal) oldModal.remove();
                    
                    // Add new modal
                    document.body.insertAdjacentHTML('beforeend', modal);
                    
                    // Set value
                    const editSelect = document.getElementById('editAppSelect');
                    const editCustomInput = document.getElementById('editCustomAppInput');
                    
                    if (found) {
                        editSelect.value = currentApp;
                    } else if (currentApp) {
                        editSelect.value = 'custom';
                        editCustomInput.style.display = 'block';
                        editCustomInput.value = currentApp;
                    }
                    
                    // Add event listener
                    editSelect.addEventListener('change', (e) => {
                        editCustomInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
                    });
                });
            },
            
            async saveAppLink() {
                const select = document.getElementById('editAppSelect');
                const customInput = document.getElementById('editCustomAppInput');
                const app = select.value === 'custom' ? customInput.value.trim() : select.value;
                
                await this.deleteRecordsByAttribute(this.currentVersion, this.currentAccount, 'app');
                if (app) {
                    await this.saveRecord(this.currentVersion, this.currentAccount, 'app', app);
                }
                await this.saveVersion(this.currentVersion);
                
                this.closeEditAppModal();
                await this.showDetailScreen();
            },
            
            closeEditAppModal() {
                const modal = document.getElementById('editAppModal');
                if (modal) modal.remove();
            },
            
            openApp(appLink) {
                window.location.href = appLink;
            },
            
            showAddAccountModal() {
                this.isEditing = false;
                const modalTitle = this.currentTag 
                    ? `Add New ${this.currentTag} Account` 
                    : 'Add New Account';
                document.getElementById('accountModalTitle').textContent = modalTitle;
                document.getElementById('accountForm').reset();
                document.getElementById('accountTitleInput').disabled = false;
                document.getElementById('activeInput').checked = true;
                document.getElementById('customFieldsEdit').innerHTML = '';
                this.openModal('accountModal');
            },
            
            async showEditAccountModal() {
                this.isEditing = true;
                document.getElementById('accountModalTitle').textContent = 'Edit Account';
                
                const records = await this.getRecordsByVersion(this.currentVersion);
                const accountRecords = records.filter(r => r.accountTitle === this.currentAccount);
                
                document.getElementById('accountTitleInput').value = this.currentAccount;
                document.getElementById('accountTitleInput').disabled = true;
                
                // Load standard fields
                accountRecords.forEach(record => {
                    switch(record.attribute) {
                        case 'username':
                            document.getElementById('usernameInput').value = record.value;
                            break;
                        case 'email':
                            document.getElementById('emailInput').value = record.value;
                            break;
                        case 'password':
                            document.getElementById('passwordInput').value = record.value;
                            break;
                        case 'url':
                            document.getElementById('urlInput').value = record.value;
                            break;
                        case 'app':
                            const select = document.getElementById('appLinkSelect');
                            const customInput = document.getElementById('customAppInput');
                            const found = Array.from(select.options).find(opt => opt.value === record.value);
                            if (found) {
                                select.value = record.value;
                            } else {
                                select.value = 'custom';
                                customInput.style.display = 'block';
                                customInput.value = record.value;
                            }
                            break;
                        case 'active_flag':
                            document.getElementById('activeInput').checked = record.value === 'true';
                            break;
                    }
                });
                
                // Load custom fields
                const customFields = accountRecords.filter(r => 
                    !['username', 'email', 'password', 'url', 'app', 'active_flag', 'tag'].includes(r.attribute)
                );
                
                const customFieldsDiv = document.getElementById('customFieldsEdit');
                let customHtml = '';
                if (customFields.length > 0) {
                    customHtml = '<h4 style="margin: 20px 0 10px; color: var(--text-secondary);">Custom Fields</h4>';
                    customFields.forEach(field => {
                        customHtml += `
                            <div class="form-group">
                                <label class="form-label">${field.attribute}</label>
                                <input type="text" class="form-input custom-field-edit" data-field-name="${field.attribute}" value="${field.value}">
                            </div>
                        `;
                    });
                }
                customFieldsDiv.innerHTML = customHtml;
                
                this.openModal('accountModal');
            },
            
            async saveAccount(e) {
                e.preventDefault();
                
                const title = document.getElementById('accountTitleInput').value.trim();
                const username = document.getElementById('usernameInput').value.trim();
                const email = document.getElementById('emailInput').value.trim();
                const password = document.getElementById('passwordInput').value;
                const url = document.getElementById('urlInput').value.trim();
                const appSelect = document.getElementById('appLinkSelect').value;
                const app = appSelect === 'custom' ? document.getElementById('customAppInput').value.trim() : appSelect;
                const active = document.getElementById('activeInput').checked;
                
                if (!title || !username || !password) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                // Check if account exists (only for new accounts)
                if (!this.isEditing) {
                    const existing = await this.getAccountRecords(this.currentVersion, title);
                    if (existing.length > 0) {
                        alert('An account with this title already exists');
                        return;
                    }
                }
                
                if (this.isEditing) {
                    // When editing: Delete everything EXCEPT tags, then save all form values
                    const oldRecords = await this.getAccountRecords(this.currentVersion, this.currentAccount);
                    
                    // Delete all non-tag records
                    for (const record of oldRecords) {
                        if (record.attribute !== 'tag') {
                            await this.deleteRecord(record.id);
                        }
                    }
                    
                    // Save the standard fields
                    await this.saveRecord(this.currentVersion, title, 'username', username);
                    if (email) await this.saveRecord(this.currentVersion, title, 'email', email);
                    await this.saveRecord(this.currentVersion, title, 'password', password);
                    if (url) await this.saveRecord(this.currentVersion, title, 'url', url);
                    if (app) await this.saveRecord(this.currentVersion, title, 'app', app);
                    await this.saveRecord(this.currentVersion, title, 'active_flag', active.toString());
                    
                    // Save custom fields from the form
                    const customFieldInputs = document.querySelectorAll('.custom-field-edit');
                    for (const input of customFieldInputs) {
                        const fieldName = input.dataset.fieldName;
                        const fieldValue = input.value.trim();
                        if (fieldValue) {
                            await this.saveRecord(this.currentVersion, title, fieldName, fieldValue);
                        }
                    }
                } else {
                    // New account - save all standard fields
                    await this.saveRecord(this.currentVersion, title, 'username', username);
                    if (email) await this.saveRecord(this.currentVersion, title, 'email', email);
                    await this.saveRecord(this.currentVersion, title, 'password', password);
                    if (url) await this.saveRecord(this.currentVersion, title, 'url', url);
                    if (app) await this.saveRecord(this.currentVersion, title, 'app', app);
                    await this.saveRecord(this.currentVersion, title, 'active_flag', active.toString());
                    
                    // If creating from a tag view, auto-add that tag
                    if (this.currentTag) {
                        await this.saveRecord(this.currentVersion, title, 'tag', this.currentTag);
                    }
                }
                
                // Update version timestamp
                await this.saveVersion(this.currentVersion);
                
                this.closeModal('accountModal');
                
                if (this.isEditing) {
                    this.currentAccount = title;
                    await this.showDetailScreen();
                } else {
                    await this.showAccountScreen();
                }
            },
            
            async deleteAccount() {
                const confirmed = confirm(`Are you sure you want to delete "${this.currentAccount}"?\n\nTip: Consider marking it as inactive instead.`);
                if (!confirmed) {
                    const inactive = confirm('Would you like to mark this account as inactive instead?');
                    if (inactive) {
                        await this.deleteRecordsByAttribute(this.currentVersion, this.currentAccount, 'active_flag');
                        await this.saveRecord(this.currentVersion, this.currentAccount, 'active_flag', 'false');
                        await this.saveVersion(this.currentVersion);
                        await this.showDetailScreen();
                    }
                    return;
                }
                
                await this.deleteAccountRecords(this.currentVersion, this.currentAccount);
                await this.saveVersion(this.currentVersion);
                await this.showAccountScreen();
            },
            
            async showTagsModal() {
                const records = await this.getRecordsByVersion(this.currentVersion);
                const accountRecords = records.filter(r => r.accountTitle === this.currentAccount);
                const accountTags = accountRecords.filter(r => r.attribute === 'tag').map(r => r.value);
                
                // Get all tags in the system
                const allTags = await this.getAllTags(this.currentVersion);
                const availableTags = allTags.filter(tag => !accountTags.includes(tag));
                
                const currentTagsDiv = document.getElementById('currentTags');
                let html = '<h4 style="margin-bottom: 10px; color: var(--text-secondary);">Current Tags</h4>';
                
                if (accountTags.length === 0) {
                    html += '<p style="color: var(--text-muted); margin-bottom: 20px;">No tags assigned</p>';
                } else {
                    accountTags.forEach(tag => {
                        html += `
                            <div class="tag-item">
                                <span class="tag-name">${tag}</span>
                                <button class="icon-btn" onclick="app.deleteTag('${tag}')" style="color: var(--danger);">üóëÔ∏è</button>
                            </div>
                        `;
                    });
                }
                
                currentTagsDiv.innerHTML = html;
                
                // Build add new section
                const addNewSection = `
                    <h4 style="margin: 20px 0 10px; color: var(--text-secondary);">Add New Tag</h4>
                    <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                        <input type="text" id="newTagInput" class="form-input" placeholder="Enter new tag name" style="flex: 1; margin: 0;">
                        <button class="icon-btn" onclick="app.addNewTag()" title="Add" style="width: 40px; height: 40px;">‚úì</button>
                    </div>
                `;
                
                // Build select existing section
                let selectExistingSection = '';
                if (availableTags.length > 0) {
                    selectExistingSection = `
                        <h4 style="margin-bottom: 10px; color: var(--text-secondary);">Select from Existing</h4>
                        <select id="existingTagSelect" class="form-input" onchange="app.addExistingTag(this.value)">
                            <option value="">-- Select Tag --</option>
                            ${availableTags.map(tag => `<option value="${tag}">${tag}</option>`).join('')}
                        </select>
                    `;
                }
                
                const addSection = document.getElementById('addTagSection');
                addSection.innerHTML = addNewSection + selectExistingSection;
                
                this.openModal('tagsModal');
            },
            
            async addNewTag() {
                const input = document.getElementById('newTagInput');
                const tagName = input.value.trim();
                
                if (!tagName) {
                    alert('Please enter a tag name');
                    return;
                }
                
                // Check if tag already exists for this account
                const records = await this.getRecordsByVersion(this.currentVersion);
                const accountRecords = records.filter(r => r.accountTitle === this.currentAccount);
                const accountTags = accountRecords.filter(r => r.attribute === 'tag').map(r => r.value);
                
                if (accountTags.includes(tagName)) {
                    alert('This tag is already assigned to this account');
                    return;
                }
                
                await this.saveRecord(this.currentVersion, this.currentAccount, 'tag', tagName);
                await this.saveVersion(this.currentVersion);
                
                // Clear input and refresh modal
                input.value = '';
                await this.showTagsModal();
            },
            
            async addExistingTag(tagName) {
                if (!tagName) return;
                
                await this.saveRecord(this.currentVersion, this.currentAccount, 'tag', tagName);
                await this.saveVersion(this.currentVersion);
                
                // Refresh modal
                await this.showTagsModal();
            },
            
            async deleteTag(tagName) {
                const records = await this.getRecordsByVersion(this.currentVersion);
                const tagRecords = records.filter(r => r.accountTitle === this.currentAccount && r.attribute === 'tag' && r.value === tagName);
                
                for (const record of tagRecords) {
                    await this.deleteRecord(record.id);
                }
                
                await this.saveVersion(this.currentVersion);
                await this.showTagsModal();
            },
            
            showCustomFieldModal() {
                this.customFieldStep = 'name'; // Track which step we're on
                this.customFieldName = null;
                this.renderCustomFieldModal();
            },
            
            async renderCustomFieldModal() {
                // Get all custom field names used across all accounts (for dropdown)
                const allRecords = await this.getRecordsByVersion(this.currentVersion);
                const allCustomFieldNames = new Set();
                allRecords.forEach(r => {
                    if (!['username', 'email', 'password', 'url', 'app', 'active_flag', 'tag'].includes(r.attribute)) {
                        allCustomFieldNames.add(r.attribute);
                    }
                });
                
                // Get current account's custom field names (to exclude from dropdown)
                const accountRecords = allRecords.filter(r => r.accountTitle === this.currentAccount);
                const currentFieldNames = accountRecords
                    .filter(r => !['username', 'email', 'password', 'url', 'app', 'active_flag', 'tag'].includes(r.attribute))
                    .map(r => r.attribute);
                
                const availableFields = Array.from(allCustomFieldNames).filter(name => !currentFieldNames.includes(name));
                
                let html = '';
                
                if (this.customFieldStep === 'name') {
                    // Step 1: Choose field name
                    html = `
                        <h3 class="modal-header">Add Custom Field</h3>
                        <h4 style="margin-bottom: 10px; color: var(--text-secondary);">Add New Custom Field</h4>
                        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                            <input type="text" id="newCustomFieldName" class="form-input" placeholder="Enter custom field name" style="flex: 1; margin: 0;">
                            <button class="icon-btn" onclick="app.setCustomFieldName('new')" title="Next" style="width: 40px; height: 40px;">‚úì</button>
                        </div>
                    `;
                    
                    if (availableFields.length > 0) {
                        html += `
                            <h4 style="margin-bottom: 10px; color: var(--text-secondary);">Select Existing Custom Field</h4>
                            <select id="existingCustomFieldSelect" class="form-input" onchange="app.setCustomFieldName(this.value)">
                                <option value="">-- Select existing custom field --</option>
                                ${availableFields.map(name => `<option value="${name}">${name}</option>`).join('')}
                            </select>
                        `;
                    }
                    
                    html += `<button class="btn" onclick="app.closeModal('customFieldModal')" style="margin-top: 20px;">Cancel</button>`;
                } else {
                    // Step 2: Enter field value
                    html = `
                        <h3 class="modal-header">Add Custom Field</h3>
                        <p style="margin-bottom: 20px; color: var(--text-secondary);">Field: <strong>${this.customFieldName}</strong></p>
                        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                            <input type="text" id="customFieldValueInput" class="form-input" placeholder="Enter custom field value" style="flex: 1; margin: 0;">
                            <button class="icon-btn" onclick="app.saveCustomFieldComplete()" title="Save" style="width: 40px; height: 40px;">‚úì</button>
                        </div>
                        <button class="btn" onclick="app.closeModal('customFieldModal')">Cancel</button>
                    `;
                }
                
                document.getElementById('customFieldModalContent').innerHTML = html;
                this.openModal('customFieldModal');
            },
            
            setCustomFieldName(source) {
                if (source === 'new') {
                    const name = document.getElementById('newCustomFieldName').value.trim();
                    if (!name) {
                        alert('Please enter a field name');
                        return;
                    }
                    this.customFieldName = name;
                } else if (source) {
                    this.customFieldName = source;
                } else {
                    return;
                }
                
                this.customFieldStep = 'value';
                this.renderCustomFieldModal();
            },
            
            async saveCustomFieldComplete() {
                const value = document.getElementById('customFieldValueInput').value.trim();
                
                if (!value) {
                    alert('Please enter a field value');
                    return;
                }
                
                await this.saveRecord(this.currentVersion, this.currentAccount, this.customFieldName, value);
                await this.saveVersion(this.currentVersion);
                this.closeModal('customFieldModal');
                await this.showDetailScreen();
            },
            
            async deleteCustomField(fieldName) {
                if (!confirm(`Delete custom field "${fieldName}"?`)) return;
                
                await this.deleteRecordsByAttribute(this.currentVersion, this.currentAccount, fieldName);
                await this.saveVersion(this.currentVersion);
                await this.showDetailScreen();
            },
            
            closeDetailScreen() {
                this.showAccountScreen();
            },
            
            async exportPrimary() {
                const records = await this.getRecordsByVersion('Primary');
                const exportData = {
                    version: 'Primary',
                    timestamp: Date.now(),
                    records: records.map(r => ({
                        accountTitle: r.accountTitle,
                        attribute: r.attribute,
                        value: r.value
                    }))
                };
                
                this.exportDataCache = JSON.stringify(exportData, null, 2);
                
                // Create default filename
                const now = new Date();
                const dateStr = now.getFullYear() + '-' +
                    String(now.getMonth() + 1).padStart(2, '0') + '-' +
                    String(now.getDate()).padStart(2, '0') + '-' +
                    String(now.getHours()).padStart(2, '0') + 
                    String(now.getMinutes()).padStart(2, '0') + 
                    String(now.getSeconds()).padStart(2, '0');
                const defaultFilename = `pvault-${dateStr}.json`;
                
                // Show filename prompt modal
                const modal = `
                    <div id="exportModal" class="modal active">
                        <div class="modal-content">
                            <h3 class="modal-header">Export Primary</h3>
                            <div class="form-group">
                                <label class="form-label">Filename</label>
                                <input type="text" id="exportFilename" class="form-input" value="${defaultFilename}">
                            </div>
                            <p style="margin-bottom: 20px; color: var(--text-secondary); font-size: 0.9rem;">File will be saved to your Files app (or Downloads on desktop)</p>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn btn-primary" onclick="app.saveExport()">üíæ Save to Files</button>
                                <button class="btn" onclick="app.copyExport()">üìã Copy to Clipboard</button>
                            </div>
                            <button class="btn" onclick="app.closeExportModal()" style="margin-top: 12px;">Cancel</button>
                        </div>
                    </div>
                `;
                
                // Remove old modal if exists
                const oldModal = document.getElementById('exportModal');
                if (oldModal) oldModal.remove();
                
                // Add new modal
                document.body.insertAdjacentHTML('beforeend', modal);
            },
            
            saveExport() {
                const filename = document.getElementById('exportFilename').value.trim();
                if (!filename) {
                    alert('Please enter a filename');
                    return;
                }
                
                // Add .json extension if not present
                const finalFilename = filename.endsWith('.json') ? filename : filename + '.json';
                
                const blob = new Blob([this.exportDataCache], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = finalFilename;
                a.click();
                URL.revokeObjectURL(url);
                this.closeExportModal();
            },
            
            async copyExport() {
                try {
                    await navigator.clipboard.writeText(this.exportDataCache);
                    alert('Copied to clipboard! Paste into Notes, email, etc.');
                    this.closeExportModal();
                } catch (err) {
                    console.error('Copy error:', err);
                    alert('Failed to copy to clipboard');
                }
            },
            
            closeExportModal() {
                const modal = document.getElementById('exportModal');
                if (modal) modal.remove();
            },
            
            async importBackup(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (!data.records || !Array.isArray(data.records)) {
                        alert('Invalid backup file format');
                        return;
                    }
                    
                    // Generate version name
                    const versions = await this.getAllVersions();
                    const versionNumbers = versions
                        .map(v => v.name.match(/^v(\d+)$/))
                        .filter(m => m)
                        .map(m => parseInt(m[1]));
                    const nextNumber = versionNumbers.length > 0 ? Math.max(...versionNumbers) + 1 : 1;
                    const versionName = `v${nextNumber}`;
                    
                    // Save records
                    for (const record of data.records) {
                        await this.saveRecord(versionName, record.accountTitle, record.attribute, record.value);
                    }
                    
                    // Save version with file timestamp
                    await this.saveVersion(versionName, data.timestamp || Date.now());
                    
                    alert(`Imported as ${versionName}`);
                    await this.showVersionScreen();
                } catch (err) {
                    console.error('Import error:', err);
                    alert('Failed to import backup file');
                }
                
                e.target.value = '';
            },
            
            async deleteCurrentVersion() {
                if (this.currentVersion === 'Primary') {
                    alert('Cannot delete Primary version');
                    return;
                }
                
                if (!confirm(`Delete version "${this.currentVersion}"?`)) return;
                
                await this.deleteRecordsByVersion(this.currentVersion);
                await this.deleteVersion(this.currentVersion);
                await this.showVersionScreen();
            },
            
            async deleteVersion(versionName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['versions'], 'readwrite');
                    const store = transaction.objectStore('versions');
                    const request = store.delete(versionName);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },
            
            pushAllToVersion() {
                this.pushType = 'all';
                this.openModal('pushModal');
            },
            
            pushAccountToVersion() {
                this.pushType = 'single';
                this.openModal('pushModal');
            },
            
            async executePush(preference) {
                if (this.pushType === 'all') {
                    await this.mergeVersionToPrimary(this.currentVersion, preference);
                    alert('All accounts pushed to Primary');
                    this.closeModal('pushModal');
                    await this.showTagScreen();
                } else {
                    await this.mergeAccountToPrimary(this.currentVersion, this.currentAccount, preference);
                    alert(`${this.currentAccount} pushed to Primary`);
                    this.closeModal('pushModal');
                    await this.showDetailScreen();
                }
            },
            
            async mergeVersionToPrimary(sourceVersion, preference) {
                const sourceRecords = await this.getRecordsByVersion(sourceVersion);
                const primaryRecords = await this.getRecordsByVersion('Primary');
                
                // Group by account
                const sourceAccounts = {};
                const primaryAccounts = {};
                
                sourceRecords.forEach(r => {
                    if (!sourceAccounts[r.accountTitle]) sourceAccounts[r.accountTitle] = [];
                    sourceAccounts[r.accountTitle].push(r);
                });
                
                primaryRecords.forEach(r => {
                    if (!primaryAccounts[r.accountTitle]) primaryAccounts[r.accountTitle] = [];
                    primaryAccounts[r.accountTitle].push(r);
                });
                
                // Merge each account
                for (const accountTitle in sourceAccounts) {
                    await this.mergeAccountToPrimary(sourceVersion, accountTitle, preference);
                }
                
                await this.saveVersion('Primary');
            },
            
            async mergeAccountToPrimary(sourceVersion, accountTitle, preference) {
                const sourceRecords = await this.getAccountRecords(sourceVersion, accountTitle);
                const primaryRecords = await this.getAccountRecords('Primary', accountTitle);
                
                // Build attribute maps
                const sourceMap = {};
                const primaryMap = {};
                
                sourceRecords.forEach(r => {
                    if (!sourceMap[r.attribute]) sourceMap[r.attribute] = [];
                    sourceMap[r.attribute].push(r.value);
                });
                
                primaryRecords.forEach(r => {
                    if (!primaryMap[r.attribute]) primaryMap[r.attribute] = [];
                    primaryMap[r.attribute].push(r.value);
                });
                
                // Delete existing primary records for this account
                await this.deleteAccountRecords('Primary', accountTitle);
                
                // Merge logic
                const allAttributes = new Set([...Object.keys(sourceMap), ...Object.keys(primaryMap)]);
                
                for (const attribute of allAttributes) {
                    const sourceValues = sourceMap[attribute] || [];
                    const primaryValues = primaryMap[attribute] || [];
                    
                    let valuesToSave = [];
                    
                    if (sourceValues.length > 0 && primaryValues.length > 0) {
                        // Conflict: use preference
                        valuesToSave = preference === 'version' ? sourceValues : primaryValues;
                    } else if (sourceValues.length > 0) {
                        // Only in source
                        valuesToSave = sourceValues;
                    } else {
                        // Only in primary
                        valuesToSave = primaryValues;
                    }
                    
                    // Save all values
                    for (const value of valuesToSave) {
                        await this.saveRecord('Primary', accountTitle, attribute, value);
                    }
                }
                
                await this.saveVersion('Primary');
            },
            
            // Database helper functions
            async saveRecord(version, accountTitle, attribute, value) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['passwords'], 'readwrite');
                    const store = transaction.objectStore('passwords');
                    const request = store.add({ version, accountTitle, attribute, value });
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },
            
            async getRecordsByVersion(version) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['passwords'], 'readonly');
                    const store = transaction.objectStore('passwords');
                    const index = store.index('version');
                    const request = index.getAll(version);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            
            async getAccountRecords(version, accountTitle) {
                const allRecords = await this.getRecordsByVersion(version);
                return allRecords.filter(r => r.accountTitle === accountTitle);
            },
            
            async deleteRecord(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['passwords'], 'readwrite');
                    const store = transaction.objectStore('passwords');
                    const request = store.delete(id);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },
            
            async deleteAccountRecords(version, accountTitle) {
                const records = await this.getAccountRecords(version, accountTitle);
                for (const record of records) {
                    await this.deleteRecord(record.id);
                }
            },
            
            async deleteRecordsByAttribute(version, accountTitle, attribute) {
                const records = await this.getAccountRecords(version, accountTitle);
                const toDelete = records.filter(r => r.attribute === attribute);
                for (const record of toDelete) {
                    await this.deleteRecord(record.id);
                }
            },
            
            async deleteRecordsByVersion(version) {
                const records = await this.getRecordsByVersion(version);
                for (const record of records) {
                    await this.deleteRecord(record.id);
                }
            },
            
            // UI helpers
            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
                window.scrollTo(0, 0);
            },
            
            openModal(modalId) {
                document.getElementById(modalId).classList.add('active');
            },
            
            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }
        };
        
        // Initialize app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.init());
        } else {
            app.init();
        }
        
        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed:', err));
        }
    </script>
</body>
</html>
